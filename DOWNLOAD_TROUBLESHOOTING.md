# دليل تشخيص مشاكل التحميل

## المشاكل الشائعة وحلولها

### 1. مشكلة "حدث خطأ أثناء تحميل اللعبة"

#### الأسباب المحتملة:
- **مشكلة في CORS**: الخادم يرفض طلبات fetch
- **مشكلة في حجم الملف**: الملف كبير جداً
- **مشكلة في timeout**: الطلب يستغرق وقتاً طويلاً
- **مشكلة في متغيرات البيئة**: `NEXT_PUBLIC_BASE_URL` غير صحيحة
- **مشكلة في الرابط الأصلي**: الرابط لا يعمل أو محذوف

#### خطوات التشخيص:

##### 1. فحص سجلات الخادم
```bash
# في Vercel
vercel logs --follow

# في Netlify
netlify logs --follow

# في الخادم المحلي
npm run dev
```

##### 2. فحص متغيرات البيئة
تأكد من إعداد `NEXT_PUBLIC_BASE_URL` بشكل صحيح:
```env
NEXT_PUBLIC_BASE_URL=https://yourdomain.com
```

##### 3. اختبار الرابط مباشرة
استخدم صفحة الاختبار: `/admin/download-test`

##### 4. فحص Firebase
تأكد من أن بيانات التحميل محفوظة بشكل صحيح في Firebase.

### 2. مشكلة "انتهت مهلة التحميل"

#### الحلول:
- **زيادة timeout**: تم زيادة timeout إلى 5 دقائق
- **تقسيم الملف**: إذا كان الملف كبير جداً
- **استخدام CDN**: لتحسين سرعة التحميل

### 3. مشكلة "الملف غير موجود"

#### الأسباب:
- الرابط الأصلي محذوف
- تغيير في إعدادات الخادم
- مشكلة في تحويل الرابط

#### الحلول:
- فحص الرابط الأصلي
- إعادة تحويل الرابط
- تحديث رابط التحميل

### 4. مشكلة "غير مسموح بالوصول للملف"

#### الأسباب:
- مشكلة في CORS
- مشكلة في إعدادات الخادم
- الرابط يتطلب مصادقة

#### الحلول:
- إضافة headers مناسبة
- فحص إعدادات CORS
- استخدام رابط بديل

### 5. مشكلة "الخادم يعيد صفحة HTML بدلاً من الملف"

#### الأسباب:
- الرابط غير صحيح أو محذوف
- الملف يتطلب مصادقة
- الخادم يعيد صفحة خطأ (404, 403, إلخ)
- الرابط يحتاج إلى تحويل
- مشكلة في إعدادات الخادم

#### الحلول:
- فحص الرابط الأصلي في المتصفح
- التأكد من أن الرابط يدعم التحميل المباشر
- استخدام رابط بديل أو خدمة استضافة أخرى
- فحص إعدادات الخادم
- تجربة تحويل الرابط باستخدام أدوات التحويل

## أدوات التشخيص

### 1. صفحة اختبار التحميل
الوصول إلى: `/admin/download-test`

**الميزات:**
- اختبار الروابط قبل إضافتها
- عرض معلومات مفصلة عن الملف
- اختبار التحميل المباشر
- عرض headers الاستجابة

### 2. سجلات التطبيق
```javascript
// في دالة handleDownloadGame
console.log('بدء عملية التحميل...', downloadLink.downloadUrl);
console.log('استجابة الخادم:', response.status, response.statusText);
console.log('نوع المحتوى:', contentType);
console.log('اسم الملف:', fileName);
console.log('حجم الملف:', blob.size, 'bytes');
```

### 3. فحص Firebase
```javascript
// فحص بيانات التحميل
const tokenDoc = await getDoc(doc(db, 'downloadTokens', tokenId));
console.log('بيانات التحميل:', tokenDoc.data());
```

## إعدادات محسنة

### 1. زيادة timeout
```javascript
signal: AbortSignal.timeout(300000), // 5 دقائق
```

### 2. إضافة headers مناسبة
```javascript
headers: {
  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
  'Accept': '*/*',
}
```

### 3. معالجة أفضل للأخطاء
```javascript
if (error.name === 'AbortError') {
  errorMessage = 'انتهت مهلة التحميل. الملف كبير جداً أو بطيء الاتصال.';
} else if (error.message.includes('404')) {
  errorMessage = 'الملف غير موجود أو تم حذفه.';
} else if (error.message.includes('403')) {
  errorMessage = 'غير مسموح بالوصول للملف.';
}
```

## خطوات التحقق

### 1. في بيئة التطوير
1. تأكد من أن التحميل يعمل محلياً
2. فحص سجلات التطبيق
3. اختبار الروابط المختلفة

### 2. في بيئة الإنتاج
1. فحص متغيرات البيئة
2. فحص سجلات الخادم
3. اختبار الروابط المباشرة
4. فحص إعدادات CORS

### 3. فحص Firebase
1. تأكد من صحة بيانات التحميل
2. فحص صلاحيات الوصول
3. تأكد من عدم حذف البيانات

## نصائح إضافية

### 1. استخدام روابط موثوقة
- تجنب روابط مؤقتة
- استخدم خدمات استضافة موثوقة
- تأكد من استقرار الروابط

### 2. مراقبة الأداء
- تتبع حجم الملفات
- مراقبة سرعة التحميل
- فحص معدل النجاح

### 3. النسخ الاحتياطي
- احتفظ بنسخ احتياطية من الملفات
- استخدم روابط بديلة
- وثق إعدادات النظام

## الاتصال بالدعم

إذا استمرت المشكلة:
1. جمع سجلات الخطأ
2. توثيق خطوات التكرار
3. فحص إعدادات الخادم
4. الاتصال بفريق الدعم الفني
